<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>External Work Evaluator (Implicit Grant – Tokyo)</title>
  <style>
    :root { --bg:#0b0d10; --card:#11151a; --muted:#9aa4b2; --text:#e6edf3; --accent:#6aa6ff; }
    html, body { height: 100%; background: var(--bg); color: var(--text); }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
    .container { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid #1f2630; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.35); }
    .card + .card { margin-top: 20px; }
    .header { padding: 20px 20px 0 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .title { font-weight: 700; font-size: 20px; letter-spacing: .2px; }
    .content { padding: 20px; }
    .grid { display:grid; gap:16px; }
    .grid-2 { grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: 1fr 2fr 2fr; } }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, textarea, button { width: 100%; box-sizing: border-box; border-radius: 10px; border: 1px solid #263041; background: #0e1217; color: var(--text); padding: 10px 12px; }
    textarea { resize: vertical; min-height: 120px; }
    button { background: #1a2330; cursor: pointer; }
    button:hover { background:#1e2a3a; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex: 1; }
    .muted { color: var(--muted); font-size: 12px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0a0d11; }
    .badge { display:inline-flex; align-items:center; gap:8px; border:1px solid #2a3446; padding:8px 10px; border-radius: 999px; background:#0e1217; font-size: 12px; }
    .small { font-size: 12px; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <noscript>
    <div class="content">This page needs JavaScript enabled.</div>
  </noscript>
  <div id="root"></div>

  <!-- React via CDN + Babel for JSX -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Implicit Grant helpers + App (with Babel presets) -->
  <script type="text/babel" data-presets="env,react">
    // ======== CONFIGURE THESE ========
    // Tokyo region
    const REGION_HOST = "mypurecloud.jp"; // API: https://api.mypurecloud.jp, Login: https://login.mypurecloud.jp
    const CLIENT_ID   = "5ad8dc1d-2ee1-41dd-9771-1c0e58f22203"; // <-- Put your OAuth client ID here
    // Redirect URI must match exactly what's set on the OAuth client (use the current page by default)
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const OAUTH_STATE  = "extwork_tokyo";
    // =================================

    function buildAuthUrl() {
      const base = `https://login.${REGION_HOST}/oauth/authorize`;
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: "token",
        redirect_uri: REDIRECT_URI,
        state: OAUTH_STATE
      });
      return `${base}?${params.toString()}`;
    }

    // Parse token & expiry from URL fragment (#access_token=...)
    function readTokenFromHash() {
      if (!location.hash) return null;
      const hashParams = new URLSearchParams(location.hash.substring(1));
      const t = hashParams.get("access_token");
      const exp = hashParams.get("expires_in");
      if (t) {
        // Clean up the URL bar
        history.replaceState({}, document.title, window.location.pathname + window.location.search);
      }
      return t ? { access_token: t, expires_in: exp ? parseInt(exp, 10) : null } : null;
    }

    const { useEffect, useMemo, useState } = React;

    function ExternalWorkEvaluatorStandalone() {
      const tokenFromHash = readTokenFromHash();
      const [region, setRegion] = useState(REGION_HOST);
      const [token, setToken] = useState(tokenFromHash ? tokenFromHash.access_token : "");
      const [expiresIn, setExpiresIn] = useState(tokenFromHash ? tokenFromHash.expires_in : null);

      const [queues, setQueues] = useState([]);
      const [loadingQueues, setLoadingQueues] = useState(false);
      const [selectedQueueId, setSelectedQueueId] = useState("");

      const [members, setMembers] = useState([]);
      const [loadingMembers, setLoadingMembers] = useState(false);
      const [selectedUserId, setSelectedUserId] = useState("");

      const [fromName, setFromName] = useState("External Work");
      const [externalRef, setExternalRef] = useState("");
      const [attributesJson, setAttributesJson] = useState('{\n  "External Reference": ""\n}');

      const [running, setRunning] = useState(false);
      const [log, setLog] = useState("");

      const baseUrl = useMemo(() => `https://api.${region}`, [region]);

      function appendLog(line) {
        const stamp = new Date().toLocaleTimeString();
        setLog(prev => `${prev}${prev ? "\\n" : ""}${stamp} • ${line}`);
      }

      function signIn() {
        if (CLIENT_ID === "REPLACE_WITH_YOUR_CLIENT_ID") {
          alert("Please set CLIENT_ID at the top of the file before signing in.");
          return;
        }
        window.location.href = buildAuthUrl();
      }

      function signOut() {
        setToken("");
        setExpiresIn(null);
        setQueues([]);
        setMembers([]);
        setSelectedQueueId("");
        setSelectedUserId("");
        setLog("");
      }

      async function api(path, init) {
        if (!token) throw new Error("Missing OAuth token");
        const res = await fetch(`${baseUrl}${path}`, {
          ...init,
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            ...(init && init.headers ? init.headers : {}),
          },
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`${res.status} ${res.statusText}: ${text}`);
        }
        return res.json();
      }

      async function loadQueues() {
        setLoadingQueues(true);
        setQueues([]);
        try {
          const items = [];
          let page = 1;
          const pageSize = 100;
          while (true) {
            const data = await api(`/api/v2/routing/queues?pageSize=${pageSize}&pageNumber=${page}`);
            if (Array.isArray(data && data.entities)) {
              for (const q of data.entities) items.push({ id: q.id, name: q.name });
            }
            const pageCount = (data && data.pageCount) || 1;
            if (page >= pageCount) break;
            page += 1;
          }
          items.sort((a, b) => a.name.localeCompare(b.name));
          setQueues(items);
          appendLog(`Loaded ${items.length} queues`);
        } catch (e) {
          appendLog(`Failed to load queues: ${e.message}`);
        } finally {
          setLoadingQueues(false);
        }
      }

      useEffect(() => {
        async function run() {
          if (!selectedQueueId) return;
          setLoadingMembers(true);
          setMembers([]);
          try {
            const out = [];
            let page = 1;
            const pageSize = 100;
            while (true) {
              const data = await api(`/api/v2/routing/queues/${selectedQueueId}/members?pageSize=${pageSize}&pageNumber=${page}`);
              if (Array.isArray(data && data.entities)) {
                for (const m of data.entities) {
                  const name = (m && m.name) || (m && m.user && m.user.name) || "(unknown)";
                  const email = m && m.user && m.user.email;
                  const id = (m && m.user && m.user.id) || (m && m.id);
                  if (id) out.push({ id, name, email });
                }
              }
              const pageCount = (data && data.pageCount) || 1;
              if (page >= pageCount) break;
              page += 1;
            }
            out.sort((a, b) => a.name.localeCompare(b.name));
            setMembers(out);
            appendLog(`Loaded ${out.length} members for queue`);
          } catch (e) {
            appendLog(`Failed to load members: ${e.message}`);
          } finally {
            setLoadingMembers(false);
          }
        }
        run();
      }, [selectedQueueId]);

      async function createExternalWork() {
        if (!selectedQueueId) return appendLog("Please select a queue");
        if (!selectedUserId) return appendLog("Please select a member (agent)");
        setRunning(true);
        setLog("");

        try {
          appendLog("Creating proxy email interaction...");
          let attributes = {};
          try {
            attributes = JSON.parse(attributesJson || "{}");
          } catch (e) {
            appendLog("Attributes JSON is invalid; defaulting to empty object");
          }
          if (externalRef) attributes["External Reference"] = externalRef;

          const createBody = {
            queueId: selectedQueueId,
            provider: "QualityForm",
            priority: 0,
            direction: "INBOUND",
            fromName: fromName || "External Work",
            attributes,
          };

          const created = await api("/api/v2/conversations/emails", {
            method: "POST",
            body: JSON.stringify(createBody),
          });
          const conversationId = (created && created.id) || (created && created.conversationId) || (created && created.conversation && created.conversation.id);
          if (!conversationId) throw new Error("No conversation id returned");
          appendLog(`Created conversation ${conversationId}`);

          appendLog("Fetching conversation to locate participantId...");
          const convo = await api(`/api/v2/conversations/${conversationId}`);
          const participants = (convo && convo.participants) || [];
          const participantId = participants && participants[1] && participants[1].id;
          if (!participantId) throw new Error("Unable to find participant at index 1; check conversation participants");
          appendLog(`Participant (index 1) = ${participantId}`);

          appendLog("Assigning to selected agent...");
          await api(`/api/v2/conversations/emails/${conversationId}/participants/${participantId}/replace`, {
            method: "POST",
            body: JSON.stringify({ userId: selectedUserId }),
          });
          appendLog("Assigned to agent");

          appendLog("Disconnecting conversation...");
          await api(`/api/v2/conversations/emails/${conversationId}`, {
            method: "PATCH",
            body: JSON.stringify({ state: "disconnected" }),
          });
          appendLog("Conversation disconnected. You can now create an evaluation.");
        } catch (e) {
          appendLog("❌ Error: " + e.message);
        } finally {
          setRunning(false);
        }
      }

      const signedIn = !!token;

      return (
        <div className="container">
          <div className="card">
            <div className="header">
              <div className="title">External Work Evaluator (Implicit – Tokyo)</div>
              <div className="row" style={{maxWidth: 520}}>
                {!signedIn ? (
                  <button onClick={signIn} className="nowrap">Sign in with Genesys Cloud</button>
                ) : (
                  <>
                    <span className="badge">Signed in • <span className="small">region:</span> {region}</span>
                    <button onClick={signOut} className="nowrap">Sign out</button>
                  </>
                )}
              </div>
            </div>
            <div className="content">
              <div className="grid grid-3">
                <div>
                  <label htmlFor="region">Region (host)</label>
                  <input id="region" value={region} onChange={(e)=>setRegion(e.target.value)} />
                  <div className="muted">Tokyo: <code>mypurecloud.jp</code></div>
                </div>
                <div className="grid-2" style={{gridColumn: "span 2"}}>
                  <div>
                    <label htmlFor="token">OAuth Access Token</label>
                    <input id="token" readOnly placeholder="Sign in to populate automatically" value={token} />
                    <div className="muted">Obtained via Implicit Grant redirect. Expires in: {expiresIn ? `${expiresIn}s` : "session-dependent"}</div>
                  </div>
                </div>
              </div>

              <div className="row" style={{marginTop: 12}}>
                <button onClick={loadQueues} disabled={!signedIn || loadingQueues}>{loadingQueues ? "Loading..." : "Load Queues"}</button>
                <div className="muted">{queues.length ? `${queues.length} queues loaded` : ""}</div>
              </div>

              <div className="grid grid-2" style={{marginTop: 16}}>
                <div>
                  <label>1) Select a Queue</label>
                  <select value={selectedQueueId} onChange={(e)=>setSelectedQueueId(e.target.value)} disabled={!signedIn}>
                    <option value="" disabled>{signedIn ? "Choose a queue" : "Sign in first"}</option>
                    {queues.map(q => (<option key={q.id} value={q.id}>{q.name}</option>))}
                  </select>
                </div>
                <div>
                  <label>2) Select a Member (Agent)</label>
                  <select value={selectedUserId} onChange={(e)=>setSelectedUserId(e.target.value)} disabled={!selectedQueueId || loadingMembers}>
                    <option value="" disabled>{loadingMembers ? "Loading members..." : (!selectedQueueId ? "Select a queue first" : "Choose a member")}</option>
                    {members.map(m => (<option key={m.id} value={m.id}>{m.name}{m.email ? ` (${m.email})` : ""}</option>))}
                  </select>
                  {selectedQueueId && !loadingMembers && !members.length && (<div className="muted">This queue appears to have no members.</div>)}
                </div>
              </div>

              <div className="grid grid-2" style={{marginTop: 16}}>
                <div>
                  <label htmlFor="fromname">3) From Name (optional)</label>
                  <input id="fromname" value={fromName} onChange={(e)=>setFromName(e.target.value)} placeholder="External Work" />
                  <div className="muted">Shown as the email remote name; searchable in Interactions.</div>
                </div>
                <div>
                  <label htmlFor="extref">External Reference (ID or URL)</label>
                  <input id="extref" value={externalRef} onChange={(e)=>setExternalRef(e.target.value)} placeholder="e.g., https://ticketing.example.com/TKT-123" />
                  <div className="muted">Links will be clickable in the Interactions UI.</div>
                </div>
              </div>

              <div style={{marginTop: 16}}>
                <label htmlFor="attrs">Custom Attributes (JSON)</label>
                <textarea id="attrs" value={attributesJson} onChange={(e)=>setAttributesJson(e.target.value)} className="log"></textarea>
                <div className="muted">Sent as the <code>attributes</code> object when creating the email. The External Reference key will be added/overridden.</div>
              </div>

              <div className="row" style={{marginTop: 16}}>
                <button onClick={createExternalWork} disabled={!signedIn || running || !selectedQueueId || !selectedUserId}>{running ? "Working..." : "Create & Assign External Work"}</button>
                <div className="muted">Creates, assigns, then disconnects the interaction.</div>
              </div>

              <div style={{marginTop: 16}}>
                <label>Run Log</label>
                <textarea readOnly rows="10" value={log} className="log"></textarea>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="header"><div className="title">Notes</div></div>
            <div className="content">
              <ul>
                <li>Tokyo region host: <code>mypurecloud.jp</code>. API base: <code>https://api.mypurecloud.jp</code>, Login: <code>https://login.mypurecloud.jp</code></li>
                <li>Implicit authorize URL is generated from the CLIENT_ID and current page URL.</li>
                <li>Queues: <code>GET /api/v2/routing/queues</code></li>
                <li>Members: <code>GET /api/v2/routing/queues/{'{queueId}'}/members</code></li>
                <li>Create: <code>POST /api/v2/conversations/emails</code></li>
                <li>Read participants: <code>GET /api/v2/conversations/{'{conversationId}'}</code></li>
                <li>Assign: <code>POST /api/v2/conversations/emails/{'{conversationId}'}/participants/{'{participantId}'}/replace</code></li>
                <li>Disconnect: <code>PATCH /api/v2/conversations/emails/{'{conversationId}'}</code> → <code>{'{ "state": "disconnected" }'}</code></li>
                <li>Ensure the OAuth client has roles/permissions to perform these operations.</li>
                <li>Redirect URI must EXACTLY match this page URL (including port). Serve locally with: <code>python3 -m http.server 8000</code></li>
              </ul>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ExternalWorkEvaluatorStandalone />);
  </script>
</body>
</html>
